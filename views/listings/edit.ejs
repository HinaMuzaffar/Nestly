<% layout("/layouts/boilerplate") %>

<div class="container mt-4">
  <div class="row">
    <div class="col-12 col-md-8 offset-md-2">
      <h3 class="mb-4">Edit your Listing</h3>

      <form
        method="POST"
        action="/listings/<%= listing._id %>?_method=PUT"
        novalidate
        class="needs-validation"
        enctype="multipart/form-data"
      >
        <!-- Title -->
        <div class="mb-3">
          <label for="title" class="form-label"><b>Title</b></label>
          <input
            name="listing[title]"
            type="text"
            value="<%= listing.title %>"
            class="form-control"
            required
          />
          <div class="invalid-feedback">Title is not valid!</div>
        </div>

        <!-- Description -->
        <div class="mb-3">
          <label for="description" class="form-label"><b>Description</b></label>
          <textarea
            name="listing[description]"
            rows="5"
            class="form-control"
            required
          ><%= listing.description %></textarea>
          <div class="invalid-feedback">Description is not valid!</div>
        </div>

        <!-- Original Images -->
        <div class="mb-3">
          <label class="form-label"><b>Original Listing Images</b></label>
          <div class="d-flex flex-wrap gap-3">
            <% if (listing.images && listing.images.length > 0) { %>
              <% listing.images.forEach((img, index) => { %>
                <div class="text-center">
                  <img
                    src="<%= img.url %>"
                    class="img-fluid rounded border"
                    style="max-width: 150px;"
                  />
                  <div class="form-check mt-2">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="deleteImages[]"
                      value="<%= img.filename %>"
                      id="delete-<%= index %>"
                    />
                    <label class="form-check-label" for="delete-<%= index %>">
                      Delete
                    </label>
                  </div>
                </div>
              <% }) %>
            <% } else { %>
              <p>No images found.</p>
            <% } %>
          </div>
        </div>

        <!-- Upload New Images -->
        <div class="mb-3">
          <label for="images" class="form-label"><b>Upload New Images</b></label>
          <input
            name="listing[images]"
            type="file"
            class="form-control"
            multiple
            accept="image/*"
          />
        </div>

        <!-- Category -->
        <div class="mb-3">
          <label for="category" class="form-label"><b>Choose Category</b></label>
          <select
            class="form-control"
            id="category"
            name="listing[category]"
            required
          >
            <option disabled>Select a category</option>
            <% for (cat of categories) { %>
              <option value="<%= cat %>" <%= listing.category === cat ? "selected" : "" %>>
                <%= cat %>
              </option>
            <% } %>
          </select>
        </div>

        <!-- Price + Country -->
        <div class="row">
          <div class="mb-3 col-12 col-md-4">
            <label for="price" class="form-label"><b>Price</b></label>
            <input
              name="listing[price]"
              value="<%= listing.price %>"
              class="form-control"
              required
            />
            <div class="invalid-feedback">Price is not valid!</div>
          </div>

          <div class="mb-3 col-12 col-md-8">
            <label for="country" class="form-label"><b>Country</b></label>
            <input
              name="listing[country]"
              type="text"
              value="<%= listing.country %>"
              class="form-control"
              required
            />
            <div class="invalid-feedback">Country name is not valid!</div>
          </div>
        </div>

        <!-- Location -->
        <div class="mb-3">
          <label for="location" class="form-label"><b>Location</b></label>
          <input
            name="listing[location]"
            type="text"
            value="<%= listing.location %>"
            class="form-control"
            required
          />
          <div class="invalid-feedback">Location is not valid!</div>
        </div>

        <!-- Cancellation Policy -->
        <div class="mb-3">
          <label for="cancellationPolicy" class="form-label"><b>Cancellation Policy</b></label>
          <textarea
            name="listing[cancellationPolicy]"
            rows="5"
            class="form-control"
            required
          ><%= listing.cancellationPolicy %></textarea>
          <div class="invalid-feedback">Cancellation Policy is not valid!</div>
        </div>

        <!-- Submit -->
        <button class="btn btn-dark w-100 mt-3">Save Changes</button>
      </form>
    </div>
  </div>
</div>
